# W4-03 å®ç°æ–‡æ¡£ï¼šå¤ä¹ é˜Ÿåˆ—ä¸æ‰“åˆ†

## ğŸ“‹ æ¦‚è¿°

**å·¥å•ç¼–å·**: W4-03  
**ä¼˜å…ˆçº§**: P0  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å®æ–½æ—¥æœŸ**: 2026-01-29

### ç›®æ ‡
å®ç° SRS å¤ä¹ åŠŸèƒ½ï¼Œå°†é¡µé¢ä» mock æ•°æ®è¿ç§»åˆ°çœŸå®æ•°æ®åº“ APIï¼Œé›†æˆ SM-2 ç®—æ³•è¿›è¡Œæ™ºèƒ½é—´éš”å¤ä¹ ã€‚

### å‰ç½®ä¾èµ–
- âœ… W4-01: SRS æ•°æ®åº“æ¶æ„å’Œ APIï¼ˆ`getDueCards`, `recordReview`ï¼‰
- âœ… W4-02: SRS æ”¶è—æŒ‰é’®é›†æˆ

---

## ğŸ¯ å®ç°å†…å®¹

### 1. ä¸»è¦æ”¹åŠ¨

#### æ–‡ä»¶ï¼š[`app/(app)/srs/page.tsx`](../app/(app)/srs/page.tsx)

**ä» Mock æ•°æ®è¿ç§»åˆ°çœŸå® APIï¼š**
```typescript
// âŒ æ—§ä»£ç ï¼ˆmockï¼‰
import { srsQueue, type SrsCard } from "@/lib/web-mock"
const [queue, setQueue] = useState(() =>
  srsQueue.filter((card) => card.due === "today")
)

// âœ… æ–°ä»£ç ï¼ˆçœŸå® APIï¼‰
import { getDueCards, recordReview } from "@/lib/srs/api"
import type { SRSCard, ReviewQuality } from "@/lib/srs/types"

useEffect(() => {
  loadDueCards()
}, [user, authLoading])

async function loadDueCards() {
  const cards = await getDueCards(50)
  setQueue(cards)
}
```

### 2. æ•°æ®ç»“æ„æ˜ å°„

| Mock æ•°æ® | çœŸå®æ•°æ®åº“ | è¯´æ˜ |
|-----------|-----------|------|
| `word` | `content.front` | å¡ç‰‡æ­£é¢ï¼ˆé—®é¢˜ï¼‰ |
| `meaning` | `content.back` | å¡ç‰‡èƒŒé¢ï¼ˆç­”æ¡ˆï¼‰ |
| `pinyin` | `content.pinyin` | æ‹¼éŸ³ï¼ˆå¯é€‰ï¼‰ |
| `interval` | `interval` | å½“å‰é—´éš”å¤©æ•° |
| `due: "today"` | `next_review <= now` | åˆ°æœŸåˆ¤æ–­ |
| - | `difficulty` | éš¾åº¦ç­‰çº§ï¼ˆ0=æ–°å¡ç‰‡ï¼‰ |
| - | `ease_factor` | éš¾æ˜“åº¦å› å­ï¼ˆ2.5 é»˜è®¤ï¼‰ |

### 3. æ‰“åˆ†ç³»ç»Ÿï¼ˆ4 æŒ‰é’®ï¼‰

ä»åŸæ¥çš„ 3 ä¸ªæŒ‰é’®ï¼ˆForgot/Hard/Goodï¼‰æ”¹ä¸º **4 ä¸ªæŒ‰é’®**ï¼Œä¸ SM-2 ç®—æ³•å¯¹é½ï¼š

| æŒ‰é’® | ReviewQuality | æ–‡å­— | é¢œè‰² | é—´éš”é¢„ä¼° | è¯´æ˜ |
|------|---------------|------|------|----------|------|
| Again | `0` | ä¸è®¤è¯† | çº¢è‰² ğŸ”´ | < 1 å¤© | å®Œå…¨ä¸è®°å¾—ï¼Œé‡ç½®é—´éš” |
| Hard | `2` | æ¨¡ç³Š | æ©™è‰² ğŸŸ  | è¾ƒçŸ­ | è®°å¾—ï¼Œä½†å¾ˆå›°éš¾ |
| Good | `3` | è®¤è¯† | ç»¿è‰² ğŸŸ¢ | æ­£å¸¸ | è®°å¾—ï¼Œæ­£å¸¸éš¾åº¦ |
| Easy | `5` | ç®€å• | é’è‰² ğŸ”µ | è¾ƒé•¿ | å®Œå…¨è®°å¾—ï¼Œéå¸¸å®¹æ˜“ |

**é—´éš”è®¡ç®—é€»è¾‘ï¼ˆæ˜¾ç¤ºé¢„ä¼°ï¼‰ï¼š**
```typescript
// Again (0): é‡ç½®ä¸º < 1 å¤©
<span>< 1å¤©</span>

// Hard (2): 
difficulty === 0 ? "1å¤©" : 
difficulty === 1 ? "1å¤©" : 
Math.round(interval * 1.2) + "å¤©"

// Good (3):
difficulty === 0 ? "1å¤©" : 
difficulty === 1 ? "6å¤©" : 
Math.round(interval * ease_factor) + "å¤©"

// Easy (5):
difficulty === 0 ? "6å¤©" : 
difficulty === 1 ? "10å¤©" : 
Math.round(interval * ease_factor * 1.3) + "å¤©"
```

### 4. å¤ä¹ æµç¨‹

```mermaid
graph TD
    A[åŠ è½½ä»Šæ—¥åˆ°æœŸå¡ç‰‡] --> B{æœ‰å¡ç‰‡?}
    B -->|å¦| C[æ˜¾ç¤ºå®ŒæˆçŠ¶æ€]
    B -->|æ˜¯| D[æ˜¾ç¤ºå¡ç‰‡æ­£é¢]
    D --> E[ç”¨æˆ·ç‚¹å‡»'æ˜¾ç¤ºç­”æ¡ˆ']
    E --> F[æ˜¾ç¤ºå¡ç‰‡èƒŒé¢ + 4ä¸ªæ‰“åˆ†æŒ‰é’®]
    F --> G[ç”¨æˆ·é€‰æ‹©æ‰“åˆ†]
    G --> H[è°ƒç”¨ recordReview API]
    H --> I[æ›´æ–°æœ¬åœ°ç»Ÿè®¡]
    I --> J{è¿˜æœ‰å¡ç‰‡?}
    J -->|æ˜¯| D
    J -->|å¦| K[æ˜¾ç¤ºå®Œæˆç•Œé¢]
```

### 5. API é›†æˆ

#### `getDueCards(limit?: number)`
- **åŠŸèƒ½**: è·å–ä»Šæ—¥åˆ°æœŸçš„å¡ç‰‡
- **è°ƒç”¨æ—¶æœº**: é¡µé¢åŠ è½½æ—¶ã€é‡ç½®å¤ä¹ æ—¶
- **è¿”å›**: `SRSCard[]`
- **è¿‡æ»¤æ¡ä»¶**: `next_review <= now`

#### `recordReview(input: RecordReviewInput)`
- **åŠŸèƒ½**: è®°å½•å¤ä¹ ç»“æœï¼Œæ›´æ–°å¡ç‰‡å‚æ•°
- **è°ƒç”¨æ—¶æœº**: ç”¨æˆ·ç‚¹å‡»æ‰“åˆ†æŒ‰é’®
- **å‚æ•°**:
  ```typescript
  {
    card_id: string,
    quality: ReviewQuality,  // 0, 2, 3, 5
    time_spent?: number      // å¯é€‰ï¼šç”¨æ—¶ï¼ˆç§’ï¼‰
  }
  ```
- **è¿”å›**: `ReviewResult`ï¼ˆåŒ…å«å¤ä¹ è®°å½• + æ›´æ–°åçš„å¡ç‰‡ï¼‰
- **å‰¯ä½œç”¨**: 
  - æ›´æ–° `user_srs_cards` è¡¨çš„ `next_review`, `interval`, `ease_factor` ç­‰
  - æ’å…¥ `user_srs_reviews` è®°å½•

---

## ğŸ§ª æµ‹è¯•éªŒæ”¶

### 1. åŠŸèƒ½éªŒæ”¶æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®
```bash
# ç¡®ä¿ Supabase å·²è¿æ¥ï¼Œå¹¶æœ‰æµ‹è¯•å¡ç‰‡
# å¯ä»¥é€šè¿‡ W4-02 çš„"åŠ å…¥ SRS"æŒ‰é’®æ·»åŠ å¡ç‰‡
```

#### æ­¥éª¤ 2ï¼šè®¿é—® SRS é¡µé¢
```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
npm run dev

# æµè§ˆå™¨è®¿é—®
http://localhost:3000/srs
```

#### æ­¥éª¤ 3ï¼šéªŒè¯æ ¸å¿ƒåŠŸèƒ½
- âœ… **åŠ è½½çŠ¶æ€**: é¡µé¢æ˜¾ç¤º"åŠ è½½ä¸­..."
- âœ… **æœ‰å¡ç‰‡**: æ˜¾ç¤ºå¡ç‰‡æ­£é¢ï¼ˆ`content.front`ï¼‰
- âœ… **æ— å¡ç‰‡**: æ˜¾ç¤º"ä»Šæ—¥å·²å®Œæˆï¼"
- âœ… **æ˜¾ç¤ºç­”æ¡ˆ**: ç‚¹å‡»åæ˜¾ç¤ºèƒŒé¢ï¼ˆ`content.back` + `pinyin`ï¼‰
- âœ… **4 ä¸ªæŒ‰é’®**: Again / Hard / Good / Easy å…¨éƒ¨æ˜¾ç¤º
- âœ… **é—´éš”é¢„ä¼°**: æ¯ä¸ªæŒ‰é’®ä¸‹æ–¹æ˜¾ç¤ºé¢„è®¡é—´éš”å¤©æ•°
- âœ… **æ‰“åˆ†**: ç‚¹å‡»ä»»æ„æŒ‰é’®åï¼š
  - è°ƒç”¨ `recordReview` API
  - ç»Ÿè®¡æ•°å­—å®æ—¶æ›´æ–°ï¼ˆå³ä¾§é¢æ¿ï¼‰
  - è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€å¼ å¡ç‰‡
- âœ… **å®Œæˆ**: å…¨éƒ¨å¤ä¹ å®Œæˆåæ˜¾ç¤ºç»Ÿè®¡æ‘˜è¦

#### æ­¥éª¤ 4ï¼šæ•°æ®åº“éªŒè¯
1. è®¿é—® Supabase æ§åˆ¶å°
2. æŸ¥çœ‹ `user_srs_reviews` è¡¨
3. éªŒè¯æ¯æ¬¡å¤ä¹ éƒ½æœ‰è®°å½•ï¼š
   - `card_id` æ­£ç¡®
   - `quality` ä¸º 0/2/3/5
   - `new_interval` å’Œ `new_ease_factor` å·²è®¡ç®—
4. æŸ¥çœ‹ `user_srs_cards` è¡¨
5. éªŒè¯å¡ç‰‡çš„ `next_review` å·²æ›´æ–°åˆ°æœªæ¥

#### æ­¥éª¤ 5ï¼šSM-2 ç®—æ³•éªŒè¯
**æµ‹è¯•åœºæ™¯**ï¼šå¤ä¹ åŒä¸€å¼ å¡ç‰‡å¤šæ¬¡ï¼ŒéªŒè¯é—´éš”å˜åŒ–

| å¤ä¹ æ¬¡æ•° | æ‰“åˆ† | é¢„æœŸ next_review | é¢„æœŸ interval |
|---------|------|-----------------|---------------|
| 1 | Good (3) | +1 å¤© | 1 |
| 2 | Good (3) | +6 å¤© | 6 |
| 3 | Good (3) | +15 å¤©ï¼ˆçº¦ï¼‰ | 15 |
| å¦‚æœ Again (0) | - | +1 å¤© | 1ï¼ˆé‡ç½®ï¼‰ |

### 2. é”™è¯¯å¤„ç†éªŒè¯
- âœ… **æœªç™»å½•**: è‡ªåŠ¨è·³è½¬åˆ° `/login`
- âœ… **ç½‘ç»œé”™è¯¯**: æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œæä¾›"é‡è¯•"æŒ‰é’®
- âœ… **API å¤±è´¥**: æ˜¾ç¤ºå…·ä½“é”™è¯¯æ¶ˆæ¯

### 3. UI/UX éªŒè¯
- âœ… è¿›åº¦æ¡æ­£ç¡®æ˜¾ç¤ºï¼ˆå¦‚ï¼š5/20ï¼‰
- âœ… å³ä¾§ç»Ÿè®¡é¢æ¿å®æ—¶æ›´æ–°
- âœ… æŒ‰é’®ç¦ç”¨çŠ¶æ€ï¼ˆå¤ä¹ ä¸­æ—¶ï¼‰
- âœ… åŠ è½½åŠ¨ç”»æµç•…
- âœ… å®Œæˆç•Œé¢æ˜¾ç¤ºæ­£ç¡®ç‡

---

## ğŸ“Š ç»Ÿè®¡æ˜¾ç¤º

### æœ¬æ¬¡ç»Ÿè®¡ï¼ˆSession Statsï¼‰
- **ä¸è®¤è¯†** (Again): çº¢è‰²ï¼Œè®¡æ•°
- **æ¨¡ç³Š** (Hard): æ©™è‰²ï¼Œè®¡æ•°
- **è®¤è¯†** (Good): ç»¿è‰²ï¼Œè®¡æ•°
- **ç®€å•** (Easy): é’è‰²ï¼Œè®¡æ•°

### è¿›åº¦ï¼ˆProgressï¼‰
- **ä»Šæ—¥å‰©ä½™**: æœªå¤ä¹ çš„å¡ç‰‡æ•°
- **å·²å®Œæˆ**: å½“å‰ä¼šè¯å·²å¤ä¹ çš„å¡ç‰‡æ•°

### å®Œæˆç•Œé¢
- **æ­£ç¡®ç‡**: `(Good + Easy) / Total * 100%`
- **4 ä¸ªæŒ‰é’®ç»Ÿè®¡**: æ˜¾ç¤ºæ¯ä¸ªé€‰é¡¹çš„è®¡æ•°

---

## ğŸ”„ SM-2 ç®—æ³•é›†æˆ

### ç®—æ³•å®ç°ä½ç½®
[`lib/srs/api.ts`](../lib/srs/api.ts) çš„ `calculateSM2()` å‡½æ•°

### ç®—æ³•å‚æ•°
- **quality**: 0-5ï¼ˆæœ¬é¡¹ç›®ä½¿ç”¨ 0, 2, 3, 5ï¼‰
- **interval**: å½“å‰é—´éš”å¤©æ•°
- **ease_factor**: éš¾æ˜“åº¦å› å­ï¼ˆ1.3 - 2.5+ï¼‰
- **difficulty**: éš¾åº¦ç­‰çº§ï¼ˆ0 = æ–°å¡ç‰‡ï¼‰

### é—´éš”è®¡ç®—è§„åˆ™
```typescript
if (quality < 3) {
  // Again æˆ– Hard: é‡ç½®é—´éš”
  newInterval = 1
  newDifficulty = 0
} else {
  // Good æˆ– Easy: å¢åŠ é—´éš”
  newDifficulty += 1
  
  if (newDifficulty === 1) newInterval = 1
  else if (newDifficulty === 2) newInterval = 6
  else newInterval = Math.round(interval * newEaseFactor)
}
```

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **æ—¶é—´æˆ³ç²¾åº¦**: ä½¿ç”¨ `next_review <= now` åˆ¤æ–­ï¼Œå¯èƒ½å­˜åœ¨æ—¶åŒºé—®é¢˜ï¼ˆå·²ä½¿ç”¨ ISO 8601/UTCï¼‰
2. **é˜Ÿåˆ—ç®¡ç†**: å½“å‰ä¸æ”¯æŒåŠ¨æ€æ·»åŠ æ–°å¡ç‰‡åˆ°é˜Ÿåˆ—ï¼ˆéœ€åˆ·æ–°é¡µé¢ï¼‰
3. **æ’¤é”€åŠŸèƒ½**: æš‚ä¸æ”¯æŒæ’¤é”€ä¸Šä¸€æ¬¡å¤ä¹ 

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ æ’¤é”€åŠŸèƒ½**: å…è®¸ç”¨æˆ·æ’¤é”€æœ€è¿‘ä¸€æ¬¡å¤ä¹ 
2. **å¿«æ·é”®æ”¯æŒ**: ä½¿ç”¨é”®ç›˜ 1/2/3/4 å¿«é€Ÿæ‰“åˆ†
3. **éŸ³é¢‘æ’­æ”¾**: æ”¯æŒå¡ç‰‡éŸ³é¢‘ï¼ˆ`content.audioUrl`ï¼‰
4. **ç»Ÿè®¡å›¾è¡¨**: é›†æˆ `getDailyReviewData()` æ˜¾ç¤ºå¤ä¹ è¶‹åŠ¿
5. **åˆ†æ‰¹åŠ è½½**: å®ç°æ— é™æ»šåŠ¨æˆ–åˆ†é¡µåŠ è½½å¤§é‡å¡ç‰‡

---

## âœ… éªŒæ”¶æ¸…å•

- [x] é¡µé¢ä½¿ç”¨çœŸå® API åŠ è½½æ•°æ®
- [x] 4 ä¸ªæ‰“åˆ†æŒ‰é’®æ­£ç¡®æ˜¾ç¤º
- [x] ç‚¹å‡»æ‰“åˆ†è°ƒç”¨ `recordReview()` API
- [x] å¤ä¹ å `next_review` æ›´æ–°åˆ°æ•°æ®åº“
- [x] ç»Ÿè®¡æ•°å­—å®æ—¶æ›´æ–°
- [x] å®Œæˆç•Œé¢æ˜¾ç¤ºå‡†ç¡®
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] åŠ è½½çŠ¶æ€å‹å¥½
- [x] TypeScript ç±»å‹å®‰å…¨

---

## ğŸ‰ Commit Message

```
feat(srs): integrate real SRS API for review queue (W4-03)

- Replace mock data with getDueCards() API
- Update review buttons to 4 options (Again/Hard/Good/Easy)
- Integrate recordReview() to save review results with SM-2 algorithm
- Display real-time review stats and progress
- Implement queue management with database sync
- Add loading states and error handling
- Show interval estimates for each review option

Related: W4-01, W4-02
Closes: W4-03
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [W4-01 æ•°æ®åº“æ¶æ„](./W4-01-database-schema.sql)
- [W4-01 è®¾ç½®æŒ‡å—](./W4-01-setup-guide.md)
- [SRS API æ–‡æ¡£](../lib/srs/api.ts)
- [SRS ç±»å‹å®šä¹‰](../lib/srs/types.ts)
- [SM-2 ç®—æ³•è¯´æ˜](https://www.supermemo.com/en/archives1990-2015/english/ol/sm2)

# W10-01: 权限与RLS回归 - 安全验收清单

## 📋 工单信息

- **工单编号**: W10-01
- **优先级**: P0（最高优先级）
- **类型**: 安全验收
- **前序工单**: W4-01（数据库表和RLS策略创建）
- **验收目标**:
  - ✅ 跨账号不可读用户数据
  - ✅ 未登录不可访问学习区

---

## 🎯 验收范围

### 1. 数据库层面（Row Level Security）

验证以下表的RLS策略：
- `user_saved_items` - 用户收藏表
- `user_srs_cards` - 用户SRS卡片表
- `user_srs_reviews` - 用户SRS复习记录表

### 2. 应用层面（路由保护）

验证以下学习区路由的访问控制：
- `/dashboard` - 用户仪表盘
- `/account` - 账号设置
- `/dictionary/*` - 词典
- `/grammar/*` - 语法
- `/lesson/*` - 课程
- `/lessons` - 课程列表
- `/medical-reader/*` - 医学阅读器
- `/path` - 学习路径
- `/reader/*` - 阅读器
- `/srs` - SRS复习系统

---

## ✅ 数据库RLS策略验收清单

### A. user_saved_items 表

#### A.1 SELECT权限验证
- [ ] **测试用例**: 用户A登录后只能看到自己的收藏
  - **执行方法**: 使用SQL脚本 `W10-01-rls-test-script.sql` 场景1.2
  - **预期结果**: `SELECT COUNT(*)` 返回用户A的收藏数，不包含其他用户数据
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法查询用户B的收藏
  - **执行方法**: 在用户A的上下文中查询 `WHERE user_id = user_b_id`
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 匿名用户无法查询任何收藏
  - **执行方法**: 不设置auth上下文，执行SELECT查询
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### A.2 INSERT权限验证
- [ ] **测试用例**: 用户A可以创建自己的收藏
  - **执行方法**: INSERT with `user_id = user_a_id`
  - **预期结果**: 插入成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法创建其他用户的收藏
  - **执行方法**: INSERT with `user_id = user_b_id`
  - **预期结果**: ERROR: new row violates row-level security policy
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 匿名用户无法创建收藏
  - **执行方法**: 不设置auth上下文，执行INSERT
  - **预期结果**: ERROR: new row violates row-level security policy
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### A.3 UPDATE权限验证
- [ ] **测试用例**: 用户A可以更新自己的收藏
  - **执行方法**: UPDATE where `user_id = user_a_id`
  - **预期结果**: 更新成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法更新其他用户的收藏
  - **执行方法**: UPDATE where `user_id = user_b_id`
  - **预期结果**: UPDATE 0（RLS阻止）
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### A.4 DELETE权限验证
- [ ] **测试用例**: 用户A可以删除自己的收藏
  - **执行方法**: DELETE where `user_id = user_a_id`
  - **预期结果**: 删除成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法删除其他用户的收藏
  - **执行方法**: DELETE where `user_id = user_b_id`
  - **预期结果**: DELETE 0（RLS阻止）
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

### B. user_srs_cards 表

#### B.1 SELECT权限验证
- [ ] **测试用例**: 用户A只能看到自己的SRS卡片
  - **执行方法**: SQL脚本场景2.2
  - **预期结果**: 只返回用户A的卡片
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法查询用户B的卡片
  - **执行方法**: WHERE `user_id = user_b_id`
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 匿名用户无法查询任何卡片
  - **执行方法**: 无auth上下文SELECT
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### B.2 INSERT权限验证
- [ ] **测试用例**: 用户A可以创建自己的SRS卡片
  - **执行方法**: INSERT with `user_id = user_a_id`
  - **预期结果**: 插入成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法创建其他用户的卡片
  - **执行方法**: INSERT with `user_id = user_b_id`
  - **预期结果**: ERROR: new row violates row-level security policy
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### B.3 UPDATE权限验证
- [ ] **测试用例**: 用户A可以更新自己的卡片
  - **执行方法**: UPDATE SRS参数 where `user_id = user_a_id`
  - **预期结果**: 更新成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法更新其他用户的卡片
  - **执行方法**: UPDATE where `user_id = user_b_id`
  - **预期结果**: UPDATE 0
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法修改user_id字段（防止数据劫持）
  - **执行方法**: UPDATE SET `user_id = user_b_id`
  - **预期结果**: ERROR: new row violates row-level security policy
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### B.4 DELETE权限验证
- [ ] **测试用例**: 用户A可以删除自己的卡片
  - **执行方法**: DELETE where `user_id = user_a_id`
  - **预期结果**: 删除成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法删除其他用户的卡片
  - **执行方法**: DELETE where `user_id = user_b_id`
  - **预期结果**: DELETE 0
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

### C. user_srs_reviews 表

#### C.1 SELECT权限验证
- [ ] **测试用例**: 用户A只能看到自己的复习记录
  - **执行方法**: SQL脚本场景3.2
  - **预期结果**: 只返回用户A的复习记录
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法查询用户B的复习记录
  - **执行方法**: WHERE `user_id = user_b_id`
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 匿名用户无法查询任何复习记录
  - **执行方法**: 无auth上下文SELECT
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### C.2 INSERT权限验证
- [ ] **测试用例**: 用户A可以创建自己的复习记录
  - **执行方法**: INSERT with `user_id = user_a_id`
  - **预期结果**: 插入成功
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法创建其他用户的复习记录
  - **执行方法**: INSERT with `user_id = user_b_id`
  - **预期结果**: ERROR: new row violates row-level security policy
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### C.3 UPDATE/DELETE权限验证（数据完整性保护）
- [ ] **测试用例**: 任何用户都无法更新复习记录
  - **执行方法**: UPDATE任意复习记录
  - **预期结果**: ERROR: permission denied 或 UPDATE 0
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败
  - **原因**: 保证历史记录的完整性和可追溯性

- [ ] **测试用例**: 任何用户都无法删除复习记录
  - **执行方法**: DELETE任意复习记录
  - **预期结果**: ERROR: permission denied 或 DELETE 0
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败
  - **原因**: 保证历史记录的完整性和可追溯性

---

### D. 跨表关联查询验证

- [ ] **测试用例**: 用户A通过JOIN只能看到自己的数据
  - **执行方法**: SQL脚本场景5.1，JOIN cards和reviews表
  - **预期结果**: 只返回用户A的卡片和复习记录
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A无法通过JOIN查询用户B的数据
  - **执行方法**: JOIN查询 WHERE `c.user_id = user_b_id`
  - **预期结果**: 返回0行
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

### E. RLS配置验证

- [ ] **测试用例**: 验证所有表已启用RLS
  - **执行方法**: 查询 `pg_tables.rowsecurity`
  - **预期结果**: 所有3个表的 `rowsecurity = true`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 验证所有RLS策略已创建
  - **执行方法**: 查询 `pg_policies`
  - **预期结果**: 
    - `user_saved_items`: 4个策略（SELECT, INSERT, UPDATE, DELETE）
    - `user_srs_cards`: 4个策略（SELECT, INSERT, UPDATE, DELETE）
    - `user_srs_reviews`: 2个策略（SELECT, INSERT）
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 验证策略使用auth.uid()
  - **执行方法**: 检查所有策略的 `qual` 和 `with_check` 字段
  - **预期结果**: 包含 `auth.uid() = user_id`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

## ✅ 应用路由保护验收清单

### F. 未登录用户访问学习区

#### F.1 手动测试
- [ ] **测试用例**: 未登录访问 `/dashboard`
  - **执行方法**: 在浏览器中清除cookie，访问 `http://localhost:3000/dashboard`
  - **预期结果**: 重定向到 `/login?redirect=/dashboard`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 未登录访问 `/srs`
  - **执行方法**: 清除cookie，访问 `/srs`
  - **预期结果**: 重定向到 `/login?redirect=/srs`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 未登录访问 `/grammar`
  - **执行方法**: 清除cookie，访问 `/grammar`
  - **预期结果**: 重定向到 `/login?redirect=/grammar`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 未登录访问 `/dictionary/医生`
  - **执行方法**: 清除cookie，访问词典详情页
  - **预期结果**: 重定向到 `/login?redirect=/dictionary/医生`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 未登录访问 `/medical-reader`
  - **执行方法**: 清除cookie，访问医学阅读器
  - **预期结果**: 重定向到 `/login?redirect=/medical-reader`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 未登录访问 `/account`
  - **执行方法**: 清除cookie，访问账号设置
  - **预期结果**: 重定向到 `/login?redirect=/account`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

#### F.2 登录后重定向
- [ ] **测试用例**: 登录后自动重定向到原页面
  - **执行方法**: 访问 `/login?redirect=/dashboard`，完成登录
  - **预期结果**: 登录成功后自动跳转到 `/dashboard`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

### G. 已登录用户访问控制

#### G.1 手动测试
- [ ] **测试用例**: 用户A登录后可以访问所有学习区
  - **执行方法**: 用户A登录，访问各个保护路由
  - **预期结果**: 所有页面正常显示，无重定向
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 用户A只能看到自己的数据
  - **执行方法**: 用户A登录，访问 `/srs`、`/account` 等页面
  - **预期结果**: 只显示用户A的SRS卡片、收藏等数据
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

### H. Middleware配置验证

- [ ] **测试用例**: 验证middleware匹配正确的路由
  - **执行方法**: 检查 [`middleware.ts`](middleware.ts) 的 `config.matcher`
  - **预期结果**: 包含所有学习区路由模式
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试用例**: 验证middleware使用Supabase SSR客户端
  - **执行方法**: 检查middleware代码
  - **预期结果**: 使用 `@supabase/ssr` 的 `createServerClient`
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

---

## ✅ 自动化测试验收（可选）

### I. Playwright E2E测试

- [ ] **测试用例**: 运行Playwright自动化测试套件
  - **执行方法**: `npm run test:e2e`（参见 `tests/e2e/W10-01-rls.spec.ts`）
  - **预期结果**: 所有测试通过
  - **实际结果**: _____
  - **状态**: ⬜ 通过 ⬜ 失败

- [ ] **测试覆盖**: 
  - [ ] 未登录访问保护路由自动重定向
  - [ ] 登录后访问学习区成功
  - [ ] 用户只能看到自己的收藏数据
  - [ ] 用户只能看到自己的SRS卡片

---

## 📊 验收结果汇总

### 统计
- **总测试用例**: ___ 个
- **通过**: ___ 个
- **失败**: ___ 个
- **通过率**: ___%

### 关键发现
_（记录测试过程中发现的问题、风险或需要改进的地方）_

1. 
2. 
3. 

### 遗留问题
_（需要跟进解决的问题）_

| 问题编号 | 问题描述 | 优先级 | 负责人 | 状态 |
|---------|---------|-------|-------|------|
| #1 | | | | |
| #2 | | | | |

---

## ✅ 最终验收决策

- [ ] **P0验收通过**: 跨账号不可读用户数据
  - 数据库RLS策略全部通过: ⬜ 是 ⬜ 否
  - 跨账号数据完全隔离: ⬜ 是 ⬜ 否

- [ ] **P0验收通过**: 未登录不可访问学习区
  - Middleware路由保护生效: ⬜ 是 ⬜ 否
  - 所有学习区路由已保护: ⬜ 是 ⬜ 否
  - 登录后正确重定向: ⬜ 是 ⬜ 否

### 最终结论
⬜ **验收通过** - 所有P0要求已满足，可以关闭工单  
⬜ **验收失败** - 存在关键问题，需要修复后重新验收

---

## 📝 签字确认

| 角色 | 姓名 | 签字 | 日期 |
|-----|------|------|------|
| 测试执行 | | | |
| 技术负责人 | | | |
| 产品负责人 | | | |

---

## 📚 相关文档

- [`docs/W4-01-database-schema.sql`](W4-01-database-schema.sql) - 数据库表和RLS策略定义
- [`docs/W10-01-rls-test-script.sql`](W10-01-rls-test-script.sql) - SQL测试脚本
- [`middleware.ts`](../middleware.ts) - Next.js中间件配置
- [`tests/e2e/W10-01-rls.spec.ts`](../tests/e2e/W10-01-rls.spec.ts) - Playwright自动化测试（可选）

---

**创建日期**: 2026-01-29  
**最后更新**: 2026-01-29  
**版本**: 1.0
